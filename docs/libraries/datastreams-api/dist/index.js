"use strict";Object.defineProperty(exports,"__esModule",{value:!0});
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};function e(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function n(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function r(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function o(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s}function i(t,e,n){if(n||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))}var s,a=function(t){return this.channelCount=void 0,this.latency=void 0,this.sampleRate=void 0,this.sampleSize=void 0,this.volume=void 0,this.whiteBalanceMode=void 0,this.exposureMode=void 0,this.focusMode=void 0,this.pointOfInterest=void 0,this.exposureCompensation=void 0,this.colorTemperature=void 0,this.iso=void 0,this.brightness=void 0,this.contrast=void 0,this.saturation=void 0,this.sharpness=void 0,this.focusDistance=void 0,this.zoom=void 0,this.torch=void 0,this.aspectRatio=void 0,this.frameRate=void 0,this.height=void 0,this.width=void 0,this.resizeMode=void 0,this.cursor=["always","motion","never"],this.displaySurface=["application","browser","monitor","window"],this.logicalSurface=!1,console.error("TODO: Get Constraints",t),this},c=function(t){function n(e){var n=t.call(this,e)||this,r=e.getConstraints();return n.deviceId=r.deviceId,n.groupId=r.groupId,n.autoGainControl=r.autoGainControl,n.channelCount=r.channelCount,n.echoCancellation=r.echoCancellation,n.latency=r.latency,n.noiseSuppression=r.noiseSuppression,n.sampleRate=r.sampleRate,n.sampleSize=r.sampleSize,n.volume=r.volume,n.aspectRatio=r.aspectRatio,n.facingMode=r.facingMode,n.frameRate=r.frameRate,n.height=r.height,n.width=r.width,n.resizeMode=r.resizeMode,n.cursor=r.cursor,n.displaySurface=r.displaySurface,n.logicalSurface=r.logicalSurface,n}return e(n,t),n}(a),u=function(t){console.error("TODO: Get Capabilities",t)},d=new Uint8Array(16);function l(){if(!s&&!(s="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return s(d)}var f=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function h(t){return"string"==typeof t&&f.test(t)}for(var v=[],p=0;p<256;++p)v.push((p+256).toString(16).substr(1));function b(t,e,n){var r=(t=t||{}).random||(t.rng||l)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,e){n=n||0;for(var o=0;o<16;++o)e[n+o]=r[o];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(v[t[e+0]]+v[t[e+1]]+v[t[e+2]]+v[t[e+3]]+"-"+v[t[e+4]]+v[t[e+5]]+"-"+v[t[e+6]]+v[t[e+7]]+"-"+v[t[e+8]]+v[t[e+9]]+"-"+v[t[e+10]]+v[t[e+11]]+v[t[e+12]]+v[t[e+13]]+v[t[e+14]]+v[t[e+15]]).toLowerCase();if(!h(n))throw TypeError("Stringified UUID is invalid");return n}(r)}var m=function(){return globalThis.crypto?globalThis.crypto.randomUUID():b()},g=function(t){function s(e){var s,d,l,f,h,v,p,b=t.call(this)||this;return b.contentHint="",b.enabled=!1,b.isolated=!1,b.muted=!1,b.remote=!1,b.id="",b.kind="",b.label="",b.readyState="live",b.data=[],b.callbacks=new Map,b.pipeline=[],b._bufferSize=30720,b.deinit=function(){b.dispatchEvent(new Event("ended"))},b.applyConstraints=function(){return n(b,void 0,void 0,(function(){return r(this,(function(t){return[2]}))}))},b.clone=function(){return b},b.getCapabilities=function(){return new u(b)},b.getConstraints=function(){return new a(b)},b.getSettings=function(){return new c(b)},b.stop=function(){},b.addData=function(t){var e;Array.isArray(t)?(e=b.data).push.apply(e,i([],o(t),!1)):b.data.push(t);for(var n=b.data.length-b._bufferSize;n>0;n--)b.data.shift();b.ondata(t)},b.ondata=function(t){b.callbacks.forEach((function(e){e(t)}))},b.subscribe=function(t){var e=m();return b.callbacks.set(e,t),e},b.unsubscribe=function(t){b.callbacks.delete(t)},b.onended=function(){b.readyState="ended"},b.onisolationchange=function(){},b.onmute=function(){},b.onunmute=function(){},b.id=null!==(s=null==e?void 0:e.id)&&void 0!==s?s:m(),b.kind=null!==(l=null===(d=null==e?void 0:e.constraints)||void 0===d?void 0:d.kind)&&void 0!==l?l:b.kind,b.label=null!==(h=null===(f=null==e?void 0:e.constraints)||void 0===f?void 0:f.label)&&void 0!==h?h:b.label,b.callbacks=new Map,b.data=[],b._bufferSize=null!==(p=null===(v=null==e?void 0:e.constraints)||void 0===v?void 0:v.bufferSize)&&void 0!==p?p:b._bufferSize,b.pipeline=[],b}return e(s,t),Object.defineProperty(s.prototype,Symbol.toStringTag,{get:function(){return"DataStreamTrack"},enumerable:!1,configurable:!0}),s}(EventTarget),w=function(t){function n(e){var n,r,o=t.call(this)||this;return o.id="",o.label="",o.send=function(t){return o.parent.send(t)},o.sendMessage=function(t){},o.id=null!==(r=null===(n=e.id)||void 0===n?void 0:n.toString())&&void 0!==r?r:m(),o.label=e.label,o.parent=e,o}return e(n,t),n}(g),k=function(t){var e=new Set;return Array.isArray(t.protocols)?t.protocols.forEach((function(t){return e.add(t)})):(t.serviceUUID&&e.add("bluetooth"),t.usbVendorId&&e.add("serial"),t.url&&(e.add("wifi"),e.add("websocket"))),{deviceId:m(),groupId:m(),kind:t.kind,label:t.label,protocols:Array.from(e),modes:null==t?void 0:t.modes}},y=function(t){function n(e){void 0===e&&(e=[]);var n=t.call(this,e)||this;return n.tracks=new Map,n.addTrack=n.addTrack,n.getDataTracks=function(){return i([],o(n.tracks.values()),!1)},n._addTrack=n.addTrack,n._getTracks=n.getTracks,n._removeTrack=n.removeTrack,n.addTrack=function(t){if(!i([],o(n.tracks.values()),!1).includes(t)){try{n._addTrack(t)}catch(t){}n.tracks.set(t.contentHint||n.tracks.size,t),n.dispatchEvent(new CustomEvent("addtrack",{detail:t}))}return t},n.removeTrack=function(t){var e,r;if(i([],o(n.tracks.values()),!1).includes(t)){try{n._removeTrack(t)}catch(t){}try{for(var s=function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(n.tracks.entries()),a=s.next();!a.done;a=s.next()){var c=o(a.value,2),u=c[0];c[1]===t&&(n.tracks.delete(u),n.dispatchEvent(new CustomEvent("removetrack",{detail:t})))}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(e)throw e.error}}}return t},n.getTracks=function(){var t=n._getTracks(),e=n.getDataTracks();return i(i([],o(t),!1),o(e),!1)},n.addEventListener("addtrack",(function(t){t.track=t.detail,delete t.detail})),n.addEventListener("removetrack",(function(t){t.track=t.detail,delete t.detail})),n}return e(n,t),Object.defineProperty(n.prototype,Symbol.toStringTag,{get:function(){return"DataStream"},enumerable:!1,configurable:!0}),n}(MediaStream),S=function t(e){var o=this;this.id=m(),this._ondata=function(t){return t},this.active=!1,this.init=function(t){var e,n,r;o.active&&o.disconnect(),t&&(Object.assign(o.constraints,t),o.onconnect=null!==(e=o.constraints.onconnect)&&void 0!==e?e:o.onconnect,o.ondisconnect=null!==(n=o.constraints.ondisconnect)&&void 0!==n?n:o.ondisconnect,o.constraints.ondata&&(o._ondata=o.constraints.ondata),o.onerror=null!==(r=o.constraints.onerror)&&void 0!==r?r:o.onerror,o.constraints.encode instanceof Function?o.encode=o.constraints.encode:o.encoder=new TextEncoder,o.constraints.decode instanceof Function?o.decode=o.constraints.decode:o.decoder=new TextDecoder("utf-8"),o.constraints.oninit instanceof Function&&(o.oninit=o.constraints.oninit)),o.oninit(o)},this.connect=function(){return n(o,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return this.device instanceof t||!this.device.connect?[3,2]:[4,this.device.connect()];case 1:e.sent(),e.label=2;case 2:return this.active=!0,this._connect(),this.onconnect(this),[2]}}))}))},this.disconnect=function(){return n(o,void 0,void 0,(function(){var e,n=this;return r(this,(function(r){switch(r.label){case 0:return this.device instanceof t||!this.device.disconnect?[3,2]:[4,this.device.disconnect()];case 1:r.sent(),r.label=2;case 2:return this.active=!1,null===(e=this.stream)||void 0===e||e.tracks.forEach((function(t){var e;return null===(e=n.stream)||void 0===e?void 0:e.removeTrack(t)})),this._disconnect(),this.ondisconnect(this),[2]}}))}))},this._connect=function(){return n(o,void 0,void 0,(function(){return r(this,(function(t){return[2]}))}))},this._disconnect=function(){return n(o,void 0,void 0,(function(){return r(this,(function(t){return[2]}))}))},this.send=function(t,e){return n(o,void 0,void 0,(function(){return r(this,(function(n){return this.onsend(t,e),[2]}))}))},this.encode=function(t,e){return o.encoder.encode(t)},this.decode=function(t,e){return o.decoder.decode(t)},this.oninit=function(t){return void 0===t&&(t=o),n(o,void 0,void 0,(function(){return r(this,(function(e){return[2,console.log("".concat(t.constructor.name," inited!"))]}))}))},this.onconnect=function(t){return void 0===t&&(t=o),n(o,void 0,void 0,(function(){return r(this,(function(e){return[2,console.log("".concat(t.constructor.name," connected!"))]}))}))},this.ondisconnect=function(t){return void 0===t&&(t=o),n(o,void 0,void 0,(function(){return r(this,(function(e){return[2,console.log("".concat(t.constructor.name," disconnected!"))]}))}))},this.onsend=function(t,e){return n(o,void 0,void 0,(function(){return r(this,(function(n){return console.log("Sent ".concat(t," from ").concat(e)),[2]}))}))},this.onerror=function(t){return n(o,void 0,void 0,(function(){return r(this,(function(e){return[2,console.log("".concat(this.constructor.name," Error: ").concat(t))]}))}))},this.ondata=function(t,e){if(o._ondata instanceof Function){var n=o._ondata(t,e);o.stream&&Object.keys(n).forEach((function(t){var e;if(o.stream){var r=null!==(e=o.stream.tracks.get(t))&&void 0!==e?e:o._createTrack(t);r instanceof g&&r.addData(n[t])}}))}},this._createTrack=function(t){if(o.stream){var e=new g(o);return"string"==typeof t&&(e.contentHint=t),o.stream.addTrack(e)}},this.constraints=e,this.device=e.device?new e.device(e):this,this.stream=e.stream,this.init(this.constraints)},T=function(t){function o(e){var o=t.call(this,e)||this;return o.characteristics={},o.connect=function(){return n(o,void 0,void 0,(function(){var t,e,o=this;return r(this,(function(i){switch(i.label){case 0:return t="string"==typeof this.constraints.serviceUUID?this.constraints.serviceUUID.toLowerCase():this.constraints.serviceUUID,e=[],t&&e.push({services:[t]}),this.constraints.namePrefix&&e.push({namePrefix:this.constraints.namePrefix}),[4,navigator.bluetooth.requestDevice({filters:e}).then((function(t){o.source=t;var e=t.gatt;return e?e.connect():Promise.reject()})).then((function(e){return t?(o.server=e,e.getPrimaryService(t)):Promise.reject()})).then((function(t){return n(o,void 0,void 0,(function(){var e,n,o,i,s=this;return r(this,(function(r){switch(r.label){case 0:for(n in this.service=t,this.source&&this.source.addEventListener("gattserverdisconnected",(function(){s.ondisconnect(s)})),e=[],this.constraints.characteristics)e.push(n);o=0,r.label=1;case 1:return o<e.length?(i=e[o],[4,this.connectCharacteristic(i,this.constraints.characteristics[i])]):[3,4];case 2:r.sent(),r.label=3;case 3:return o++,[3,1];case 4:return this.onconnect(this),[2]}}))}))})).catch((function(t){return console.error(t),o.onerror(t),Promise.reject()}))];case 1:return i.sent(),[2]}}))}))},o._disconnect=function(){return n(o,void 0,void 0,(function(){var t;return r(this,(function(e){return null===(t=this.server)||void 0===t||t.disconnect(),[2]}))}))},o.send=function(t,e){return n(o,void 0,void 0,(function(){return r(this,(function(n){return this.transmitCharacteristic?[2,this.transmitCharacteristic.writeValue(this.encode(t,e))]:[2]}))}))},o.onnotification=function(t,e){o.ondata(o.decode(t.target.value,e),e)},o.connectCharacteristic=function(t,e){return n(o,void 0,void 0,(function(){var n,o,i=this;return r(this,(function(r){switch(r.label){case 0:return Array.isArray(e)?[4,Promise.all(e.map((function(e,n){return i.connectCharacteristic("".concat(t).concat(n),e)})))]:[3,2];case 1:return r.sent(),[3,4];case 2:return e="string"==typeof e?e.toLowerCase():e,this.service?[4,this.service.getCharacteristic(e)]:[3,4];case 3:if(n=r.sent(),this.characteristics[t]=n,((o=n.properties).write||o.writeWithoutResponse)&&(this.transmitCharacteristic=n),o.notify)return n.addEventListener("characteristicvaluechanged",(function(e){i.onnotification(e,t)})),[2,n.startNotifications()];r.label=4;case 4:return[2]}}))}))},o}return e(o,t),o}(S),D=function(t){function o(e){var o=t.call(this,e)||this;return o.displayPorts=[],o.encodedBuffer="",o.connected=!1,o.recordData=!1,o.recorded=[],o.port=null,o.decoder=new TextDecoder,o.subscribed=!1,o.readable=null,o.writer=null,o.monitoring=!1,o.newSamples=0,o.monitorSamples=1e4,o.monitorData=[],o.monitorIdx=0,o.connect=function(){return n(o,void 0,void 0,(function(){var t,e,n,o,i;return r(this,(function(r){switch(r.label){case 0:return t=this.constraints,e=t.usbVendorId,n=t.usbProductId,o=/[0-9A-Fa-f]{6}/g,e&&"string"!=typeof e&&!o.test(e+"")&&(e="0x".concat(e.toString(16))),n&&"string"!=typeof n&&!o.test(n+"")&&(n="0x".concat(n.toString(16))),i=[{usbVendorId:e,usbProductId:n}],[4,navigator.serial.requestPort({filters:i}).then(this.onPortSelected)];case 1:return r.sent(),[2]}}))}))},o.send=function(t){return n(o,void 0,void 0,(function(){var e,n,o,i;return r(this,(function(r){switch(r.label){case 0:for(e=unescape(encodeURIComponent(t+="\n")),n=new Uint8Array(e.length),o=0;o<e.length;++o)n[o]=e.charCodeAt(o);return navigator.serial&&this.port.writable?[4,(i=this.port.writable.getWriter()).write(n.buffer)]:[3,2];case 1:r.sent(),i.releaseLock(),r.label=2;case 2:return[2]}}))}))},o.subscribe=function(t){return void 0===t&&(t=o.port),n(o,void 0,void 0,(function(){var e,o=this;return r(this,(function(i){return t.readable&&!0===this.subscribed?(this.readable=t.readable,console.error("Managing the readable stream internally"),e=new TransformStream({transform:function(t){return n(o,void 0,void 0,(function(){return r(this,(function(e){if(console.log("streaming"),!this.subscribed)throw Error("Device disconnected");return this.onReceive(t),[2,t]}))}))}}),this.readable.pipeThrough(e).pipeTo(new WritableStream({})).then((function(){return console.log("All data successfully written!")})).catch((function(t){return o.handleError(t)})),[2,!0]):[2,!1]}))}))},o.handleError=function(t){return n(o,void 0,void 0,(function(){var e=this;return r(this,(function(o){switch(o.label){case 0:return console.log(t),t.message.includes("framing")||t.message.includes("overflow")||t.message.includes("overrun")||t.message.includes("Overflow")||t.message.includes("break")?(this.subscribed=!1,setTimeout((function(){return n(e,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return this.readable?[4,this.readable.cancel()]:[3,2];case 1:t.sent(),this.readable=null,t.label=2;case 2:return this.subscribed=!0,this.subscribe(this.port),[2]}}))}))}),30),[3,4]):[3,1];case 1:return t.message.includes("parity")||t.message.includes("Parity")?(this.port&&(this.subscribed=!1,setTimeout((function(){return n(e,void 0,void 0,(function(){var t=this;return r(this,(function(e){switch(e.label){case 0:return this.readable?[4,this.readable.cancel()]:[3,2];case 1:e.sent(),this.readable=null,e.label=2;case 2:return[4,this.port.close()];case 3:return e.sent(),this.connected=!1,setTimeout((function(){t.onPortSelected(t.port)}),100),[2]}}))}))}),50)),[3,4]):[3,2];case 2:return[4,this._disconnect()];case 3:o.sent(),o.label=4;case 4:return[2]}}))}))},o.onPortSelected=function(t){return n(o,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:this.port=t,navigator.serial.addEventListener("disconnect",this.disconnect),e={baudRate:115200,bufferSize:1e3},"object"==typeof this.constraints.serialOptions&&Object.assign(e,this.constraints.serialOptions),n.label=1;case 1:return n.trys.push([1,3,,5]),[4,t.open(e)];case 2:return n.sent(),[3,5];case 3:return n.sent(),[4,t.open(e)];case 4:return n.sent(),[3,5];case 5:return this.active=!0,this.onconnect(this),this.connected=!0,this.subscribed=!0,[4,this.subscribe(t)];case 6:return n.sent(),[2]}}))}))},o.onReceive=function(t){var e;for(o.encodedBuffer+=o.decoder.decode(t);(e=o.encodedBuffer.indexOf("\n"))>=0;){var n=o.encodedBuffer.substr(0,e+1);1==o.recordData&&o.recorded.push(n),(o.monitoring=!0)&&(o.newSamples++,o.monitorData.push(n)),o.ondata(n),o.encodedBuffer=o.encodedBuffer.substr(e+1)}},o._disconnect=function(){return n(o,void 0,void 0,(function(){return r(this,(function(t){return this.closePort(),[2]}))}))},o.closePort=function(t){return void 0===t&&(t=o.port),n(o,void 0,void 0,(function(){var e=this;return r(this,(function(o){return this.port&&(this.subscribed=!1,setTimeout((function(){return n(e,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),console.log("clsing",this.readable),this.readable?[4,this.readable.cancel()]:[3,2];case 1:n.sent(),this.readable=null,n.label=2;case 2:return[4,t.close()];case 3:return n.sent(),this.connected=!1,[3,5];case 4:return e=n.sent(),console.error(e),[3,5];case 5:return[2]}}))}))}),50)),[2]}))}))},navigator.serial?o.decoder=new TextDecoder:(console.log("ERROR: Cannot locate navigator.serial. Enable #experimental-web-platform-features in chrome://flags"),alert("Serial support not found. Enable #experimental-web-platform-features in chrome://flags or use a chrome extension")),o}return e(o,t),o}(S),x=function(t){console.log("Logic not implemented",t)},E=function(t){if("string"==typeof t&&(t=JSON.parse(t)),"object"==typeof t){for(var e in t){var n=t[e],r=new RegExp("(|[a-zA-Z]w*|([a-zA-Z]w*(,s*[a-zA-Z]w*)*))s*=>"),o="string"==typeof n&&"function"==n.substring(0,8),i="string"==typeof n&&r.test(n);try{t[e]=o||i?new Function(n):n}catch(r){console.error(r,n),t[e]=n}"object"==typeof t[e]&&E(t[e])}return t}return{}},_=function(t){for(var e in t)t[e]instanceof Function&&(t[e]=t[e].toString()),t[e]instanceof Object&&_(t[e]);return JSON.stringify(t)},C=function(t,e){var n=this;void 0===t&&(t="http://localhost"),this.sendBuffer=[],this.callbacks=new Map,this.ready=!1,this._onopen=function(){n.ready=!0,n.sendBuffer.forEach((function(t){n.ws&&n.ws.send(t)})),n.onopen()},this._onclose=function(){n.ready=!1,n.onclose()},this._onerror=function(t){return console.error(t),n.onerror(t),t},this._onmessage=function(t){try{var e=E(t.data);if(e.error)console.error(e.error);else{var r=e.callbackId,o=e;if(r){o=o.data;var i=n.callbacks.get(r);i&&i(o)}o&&n.onmessage(o)}}catch(e){console.error("Error parsing WebSocket message from server: ",t.data,e)}},this.onopen=function(){},this.onclose=function(){},this.onerror=function(){},this.onmessage=function(){},this.addEventListener=function(t,e){n.ws&&("message"===t?n.ws.addEventListener(t,(function(t){e(JSON.parse(t.data))})):n.ws.addEventListener(t,e))},this.close=function(){n.ws&&n.ws.close()},this.send=function(t,e){return void 0===e&&(e="websocket"),new Promise((function(r){var o=m();n.callbacks.set(o,(function(t){r(t),n.callbacks.delete(o)}));var i=_({data:t,callbackId:o,service:e});n.ready&&n.ws?n.ws.send(i):n.sendBuffer.push(i)}))},this.url=t;var r=new URL(t),o=[];if(Object.keys(e).forEach((function(t){o.push("".concat(t,".brainsatplay.com%").concat(e[t]))})),console.log(o),"http:"===r.protocol)this.ws=new WebSocket("ws://"+r.host,o.join(";"));else{if("https:"!==r.protocol)return void console.log("invalid protocol");this.ws=new WebSocket("wss://"+r.host,o.join(";"))}this.sendBuffer=[],this.callbacks=new Map,this.ws.onopen=this._onopen,this.ws.onerror=this._onerror,this.ws.onmessage=this._onmessage,this.ws.onclose=this._onclose,globalThis.onunload=globalThis.onbeforeunload=function(){n.ws&&(n.ws.onclose=function(){}),console.log("C:OSING"),n.close()}},P=function(t){function o(e){var o=t.call(this,e)||this;return o._connect=function(){return n(o,void 0,void 0,(function(){var t=this;return r(this,(function(e){return this.socket&&this.socket.url==this.constraints.url||(this.socket=new C(this.constraints.url,{services:["websocket"]}),this.socket.onmessage=function(e){"websocket"===e.service&&t.ondata(e.data)}),[2]}))}))},o._disconnect=function(){return n(o,void 0,void 0,(function(){var t;return r(this,(function(e){return null===(t=this.socket)||void 0===t||t.close(),[2]}))}))},o.send=function(t){return n(o,void 0,void 0,(function(){var e;return r(this,(function(n){return[2,null===(e=this.socket)||void 0===e?void 0:e.send(t)]}))}))},o}return e(o,t),o}(S),M=function(t){function s(){var e=t.call(this)||this;return e.devices=[],e.load=function(t){var n;Array.isArray(t)?(n=e.devices).push.apply(n,i([],o(t),!1)):t&&e.devices.push(t)},e.enumerateDevices=function(){return n(e,void 0,void 0,(function(){var t,e,n;return r(this,(function(r){switch(r.label){case 0:return[4,navigator.usb.getDevices()];case 1:return t=r.sent(),[4,navigator.serial.getPorts()];case 2:return e=r.sent(),n=[],[4,navigator.mediaDevices.enumerateDevices()];case 3:return[2,i(i(i(i([],o(r.sent()),!1),o(e),!1),o(t),!1),o(n),!1)]}}))}))},e.getSupportedDevices=function(t){return n(e,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:return e=[],t&&"media"!==t?[3,2]:[4,navigator.mediaDevices.enumerateDevices()];case 1:e=n.sent(),n.label=2;case 2:return[2,i(i([],o(e),!1),o(this.devices),!1)]}}))}))},e.getDeviceInfo=function(t){return k(t)},e.getSupportedConstraints=function(){return n(e,void 0,void 0,(function(){return r(this,(function(t){return[2,new x(this)]}))}))},e.getDevice=function(t){if(t.protocol){if(t.protocol.includes("bluetooth"))return new T(t);if(t.protocol.includes("serial"))return new D(t);if(t.protocol.includes("websocket"))return new P(t)}},e.startDataStream=function(t,o){return void 0===o&&(o=new y),n(e,void 0,void 0,(function(){var e,n,i;return r(this,(function(r){switch(r.label){case 0:if(t.stream=o,(n=Object.assign({},t)).device)e=new S(n);else if((e=this.getDevice(n))||(i=k(t),n.protocol=[],i.protocols.forEach((function(t){return n.protocol.push(t)})),e=this.getDevice(n)),!e)return[2,new S(t)];return[4,e.connect().then((function(t){return t})).catch((function(){throw"Device not connected"}))];case 1:return r.sent(),[2,e]}}))}))},e.getUserStream=function(t){return n(e,void 0,void 0,(function(){var e,n,o;return r(this,(function(r){switch(r.label){case 0:return t.video||t.audio?[4,navigator.mediaDevices.getUserMedia(t)]:[3,2];case 1:e=r.sent(),r.label=2;case 2:return n=new y(e),t.screen?[4,navigator.mediaDevices.getDisplayMedia({video:!0})]:[3,4];case 3:r.sent().getTracks().forEach(n.addTrack),r.label=4;case 4:return[4,this.startDataStream(t,n)];case 5:return o=r.sent(),n.getTracks().forEach((function(e){e.applyConstraints(t)})),[2,o]}}))}))},e}return e(s,t),Object.defineProperty(s.prototype,Symbol.toStringTag,{get:function(){return"DataDevices"},enumerable:!1,configurable:!0}),s}(EventTarget),O=[],I=[],R=function(t,e){return e.push(t)},j=function(t,e){return e[e.length-1].pipeTo(t)},A=function(t,e,n){e.push(t),n.push(n[n.length-1].pipeThrough(t))};self.onmessage=function(t){return n(void 0,void 0,void 0,(function(){return r(this,(function(e){return"init"===t.data.cmd&&t.data.data.source.pipeThrough(t.data.data.transformer).pipeTo(t.data.data.sink),"add"===t.data.cmd&&A(t.data.data,O,I),"source"===t.data.cmd&&R(t.data.data,I),"sink"===t.data.cmd&&j(t.data.data,I),[2]}))}))};var U=self,z=function(t){var e=this;this.start=function(t){e.track&&(e.track.data.forEach((function(e){return t.enqueue(e)})),e.subid=e.track.subscribe((function(e){return t.enqueue(e)})))},this.pull=function(){},this.cancel=function(){e.track&&e.subid&&e.track.unsubscribe(e.subid)},this.track=t.track,this.readable=new ReadableStream({start:this.start,pull:this.pull,cancel:this.cancel},{})},L=function(t){function n(){var e=t.call(this)||this;return e.start=function(){},e.write=function(t){return e.addData(t)},e.close=function(){return console.log("All data successfully read!")},e.abort=function(t){return console.error("Something went wrong!",t)},e.writable=new WritableStream({start:e.start,write:e.write,close:e.close,abort:e.abort}),e}return e(n,t),n}(g),B=function(t){var e=this,o=(void 0===t?{thread:!0}:t).thread;if(this.id=m(),this.pipeline=[],this.bound=[],this.source=null,this.sink=null,this.kind="",this.thread=!0,this.setSource=function(t){var n;t instanceof MediaStreamTrack&&("video"===t.kind||"audio "===t.kind)?"MediaStreamTrackProcessor"in window?n=new MediaStreamTrackProcessor({track:t}):alert("Your browser does not support the experimental MediaStreamTrack API for Insertable Streams of Media"):t instanceof g&&(n=new z({track:t})),e.kind=t.kind,n&&(e.source=n.readable,e.thread&&e.worker?e.worker.postMessage({cmd:"source",data:e.source},[e.source]):R(e.source,e.bound))},this.setSink=function(t){void 0===t&&(t=e.kind),"video"===t||"audio"===t?"MediaStreamTrackGenerator"in window?e.output=new MediaStreamTrackGenerator({kind:t}):alert("Your browser does not support the experimental MediaStreamTrack API for Insertable Streams of Media"):e.output=new L,e.output&&(e.sink=e.output.writable,e.thread&&e.worker?e.worker.postMessage({cmd:"sink",data:e.sink},[e.sink]):j(e.sink,e.bound))},this.add=function(t){var o;if(t instanceof TransformStream)o=t;else{var i=void 0;i=t instanceof Function?{transform:function(o,i){return n(e,void 0,void 0,(function(){return r(this,(function(e){return[2,i.enqueue(t(o))]}))}))}}:{transform:function(o,i){return n(e,void 0,void 0,(function(){return r(this,(function(e){return[2,i.enqueue(t.function(o))]}))}))}},o=new TransformStream(i)}e.pipeline.push(o),e.thread&&e.worker?(e.pipeline.push(o),e.worker.postMessage({cmd:"add",data:o},[o])):A(o,e.pipeline,e.bound)},this.thread=o,this.thread)try{this.worker=new Worker("./src/pipeline.worker",{name:"pipelineworker",type:"module"})}catch(t){try{this.worker=U}catch(t){console.log("Error creating worker. ERROR:",t)}}},G=function(){this.audio=!1,this.video=!1,this.peerIdentity=null},V=function(t){this.transform=new TransformStream({start:F,flush:W,transform:t.transform})};function F(){}function W(){}exports.DataChannel=w,exports.DataDeviceInfo=k,exports.DataDevices=M,exports.DataPipeline=B,exports.DataStream=y,exports.DataStreamConstraints=G,exports.DataStreamTrack=g,exports.DataStreamTrackGenerator=L,exports.DataStreamTrackProcessor=z,exports.DataStreamTrackTransform=V,exports.DataTrackCapabilities=u,exports.DataTrackConstraints=a,exports.DataTrackSettings=c,exports.DataTrackSupportedConstraints=x;
